#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define LOOKUP_TABLE_FILE "precalculated.table"
#define LOOKUP_TABLE_SIZE (24 * 1024 * 1024) // 24 MB

int main(int argc, char *argv[])
{
    size_t index = 0;
    int ch;
    const char *input_filename = argv[1];
    const char *output_filename = "decrypted";


    if (argc != 2)
    {
        fprintf(stderr, "%s <encrypted_file>\n", argv[0]);
        return EXIT_FAILURE;
    }

    FILE *lookup_fp = fopen(LOOKUP_TABLE_FILE, "rb");
    if (!lookup_fp)
    {
        perror("Error opening lookup.table");
        return EXIT_FAILURE;
    }

    unsigned char *lookup_table = (unsigned char *)malloc(LOOKUP_TABLE_SIZE);
    if (!lookup_table)
    {
        perror("Memory allocation failed for lookup table");
        fclose(lookup_fp);
        return EXIT_FAILURE;
    }

    size_t lookup_read = fread(lookup_table, 1, LOOKUP_TABLE_SIZE, lookup_fp);
    fclose(lookup_fp);
    if (lookup_read == 0)
    {
        fprintf(stderr, "Failed to read any data from lookup.table\n");
        free(lookup_table);
        return EXIT_FAILURE;
    }

    FILE *input_fp = fopen(input_filename, "rb");
    if (!input_fp)
    {
        perror("Error opening input file");
        free(lookup_table);
        return EXIT_FAILURE;
    }

    FILE *output_fp = fopen(output_filename, "wb");
    if (!output_fp)
    {
        perror("Error opening output file");
        fclose(input_fp);
        free(lookup_table);
        return EXIT_FAILURE;
    }

   while ((ch = fgetc(input_fp)) != EOF && index < lookup_read)
    {
        unsigned char decrypted_byte = (unsigned char)ch ^ lookup_table[index];
        fputc(decrypted_byte, output_fp);
        index++;
    }

    fclose(input_fp);
    fclose(output_fp);
    free(lookup_table);

    printf("completed: '%s'.\n", output_filename);
    return EXIT_SUCCESS;
}

